{% extends 'mainapp/base.html' %}

{% block title %}Live Map{% endblock %}

{% block content %}
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">Live Shuttle Tracker</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'root' %}">Home</a></li>
                    <li class="breadcrumb-item active">Map</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="app-content">
    <div class="container-fluid">
        <div class="row g-3">
            
            <div class="col-lg-9 col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-0 position-relative">
                        <div id="map" style="height: 75vh; width: 100%; border-radius: 0.375rem;"></div>
                        
                        <div class="position-absolute bottom-0 start-0 m-3 p-2 bg-white rounded shadow-sm opacity-75 small" style="z-index: 1000;">
                            <div><span style="color: blue;">&#9644;</span> Routes</div>
                            <div><span style="color: black;">&#9679;</span> Stops</div>
                            <div><span>üöå</span> Active Bus</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-4">
                <div class="card card-primary card-outline shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title m-0">Active Shuttles</h5>
                        <div class="card-tools">
                            <span class="badge bg-primary rounded-pill" id="shuttle-count">0</span>
                        </div>
                    </div>
                    
                    <div class="card-body p-0" style="max-height: 75vh; overflow-y: auto;">
                        <ul id="shuttle-list" class="list-group list-group-flush">
                            <li class="list-group-item text-center py-5 text-muted">
                                <div class="spinner-border text-primary spinner-border-sm mb-2" role="status"></div>
                                <p class="mb-0 small">Searching for GPS signals...</p>
                            </li>
                        </ul>
                    </div>

                    <div class="card-footer bg-light small text-center text-muted">
                        <i class="bi bi-broadcast me-1 text-success"></i> Auto-updating
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. Initialize Map
    var map = L.map('map').setView([2.9289, 101.6417], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var busMarkers = {}; 

    // 2. Load Static Data (Routes & Stops)
    function loadStaticMapData() {
        
        // A. Draw Routes (With OSRM Snapping)
        fetch("{% url 'api_routes' %}")
            .then(res => res.json())
            .then(data => {
                data.routes.forEach(route => {
                    if (route.coords.length > 1) {
                        // Prepare coordinates for OSRM (Lng,Lat format required)
                        var waypoints = route.coords.map(c => `${c[1]},${c[0]}`).join(';');
                        var osrmUrl = `https://router.project-osrm.org/route/v1/driving/${waypoints}?overview=full&geometries=geojson`;

                        fetch(osrmUrl)
                            .then(r => r.json())
                            .then(osrmData => {
                                if (osrmData.routes && osrmData.routes.length > 0) {
                                    // 1. Draw the snapped road path
                                    var roadCoords = osrmData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                                    L.polyline(roadCoords, {
                                        color: route.color,
                                        weight: 5,
                                        opacity: 0.8,
                                        lineJoin: 'round'
                                    }).addTo(map).bindPopup(`<b>Route:</b> ${route.name}`);
                                } else {
                                    // Fallback: Straight lines if OSRM fails
                                    console.warn("OSRM returned no route, using straight lines.");
                                    L.polyline(route.coords, { color: route.color, weight: 4, opacity: 0.5, dashArray: '5,5' }).addTo(map);
                                }
                            })
                            .catch(e => {
                                console.error("OSRM Error:", e);
                                // Fallback on error
                                L.polyline(route.coords, { color: route.color, weight: 4, opacity: 0.5, dashArray: '5,5' }).addTo(map);
                            });
                    }
                });
            });

        // B. Draw Stops
        fetch("{% url 'api_stops' %}")
            .then(res => res.json())
            .then(data => {
                var stopIcon = L.divIcon({
                    className: 'custom-stop-icon',
                    html: '<div style="background:white; border:2px solid #333; width:12px; height:12px; border-radius:50%; box-shadow: 1px 1px 3px rgba(0,0,0,0.3);"></div>',
                    iconSize: [12, 12]
                });
                data.stops.forEach(stop => {
                    L.marker([stop.lat, stop.lng], {icon: stopIcon}).addTo(map)
                     .bindPopup(`<b>üöè Stop:</b> ${stop.name}`);
                });
            });
    }

    // 3. Live Updates
    function updateBuses() {
        fetch("{% url 'api_shuttles' %}")
            .then(res => res.json())
            .then(data => {
                // Update Badge Count
                document.getElementById('shuttle-count').innerText = data.shuttles.length;
                
                var listHtml = '';
                var activeIds = [];

                if (data.shuttles.length === 0) {
                    listHtml = `
                        <li class="list-group-item text-center py-5 text-muted">
                            <i class="bi bi-bus-front fs-1 text-secondary opacity-50"></i>
                            <p class="mt-2 mb-0">No shuttles currently active.</p>
                        </li>`;
                }

                data.shuttles.forEach(bus => {
                    activeIds.push(bus.id);
                    
                    // Add to Sidebar List
                    listHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold text-primary">${bus.plate}</h6>
                                <small class="text-muted">${bus.route}</small>
                            </div>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10">
                                Live
                            </span>
                        </li>`;

                    // Map Marker Logic
                    var popupContent = `
                        <div class="text-center p-1">
                            <b class="d-block text-primary mb-1">${bus.route}</b>
                            <span class="badge bg-dark">${bus.plate}</span>
                        </div>`;

                    if (busMarkers[bus.id]) {
                        busMarkers[bus.id].setLatLng([bus.lat, bus.lng]).setPopupContent(popupContent);
                    } else {
                        var busIcon = L.divIcon({
                            className: 'bus-marker',
                            html: '<div style="font-size:24px; filter: drop-shadow(2px 4px 6px black);">üöå</div>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        var marker = L.marker([bus.lat, bus.lng], {icon: busIcon}).addTo(map).bindPopup(popupContent);
                        busMarkers[bus.id] = marker;
                    }
                });

                document.getElementById('shuttle-list').innerHTML = listHtml;

                // Remove stale markers
                for (var id in busMarkers) {
                    if (!activeIds.includes(parseInt(id))) {
                        map.removeLayer(busMarkers[id]);
                        delete busMarkers[id];
                    }
                }
            })
            .catch(err => console.error(err));
    }

    loadStaticMapData();
    updateBuses();
    setInterval(updateBuses, 10000); // 10 seconds refresh
</script>
{% endblock %}