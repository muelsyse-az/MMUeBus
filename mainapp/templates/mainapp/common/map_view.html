{% extends 'mainapp/base.html' %}
{% load static %}

{% block title %}Live Map{% endblock %}

{% block content %}
<style>
    /* 1. Custom Bus Marker Styles */
    .bus-marker-container {
        position: relative;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bus-icon-img {
        width: 36px;
        height: 36px;
        z-index: 20;
        filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4));
        transition: transform 0.3s ease;
    }

    /* 2. Pulse Animation */
    .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid rgba(13, 110, 253, 0.6);
        background-color: rgba(13, 110, 253, 0.1);
        z-index: 10;
        animation: pulsate 2s infinite ease-out;
    }

    @keyframes pulsate {
        0% { width: 30px; height: 30px; opacity: 1; border-width: 3px; }
        100% { width: 80px; height: 80px; opacity: 0; border-width: 0px; }
    }
</style>

<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">Live Shuttle Tracker</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="{% url 'root' %}">Home</a></li>
                    <li class="breadcrumb-item active">Map</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="app-content">
    <div class="container-fluid">
        <div class="row g-3">
            
            <div class="col-lg-9 col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-0 position-relative">
                        <div id="map" style="height: 75vh; width: 100%; border-radius: 0.375rem;"></div>
                        
                        <div class="position-absolute bottom-0 start-0 m-3 p-2 bg-white rounded shadow-sm opacity-75 small" style="z-index: 1000;">
                            <div><span style="color: blue;">&#9644;</span> Routes</div>
                            <div><span style="color: black;">&#9679;</span> Stops</div>
                            <div><span><img src="{% static 'img/bus_marker.png' %}" style="width:16px;"></span> Active Bus</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-4">
                <div class="card card-primary card-outline shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title m-0">Active Shuttles</h5>
                        <div class="card-tools">
                            <span class="badge bg-primary rounded-pill" id="shuttle-count">0</span>
                        </div>
                    </div>
                    
                    <div class="card-body p-0" style="max-height: 75vh; overflow-y: auto;">
                        <ul id="shuttle-list" class="list-group list-group-flush">
                            <li class="list-group-item text-center py-5 text-muted">
                                <div class="spinner-border text-primary spinner-border-sm mb-2" role="status"></div>
                                <p class="mb-0 small">Searching for GPS signals...</p>
                            </li>
                        </ul>
                    </div>

                    <div class="card-footer bg-light small text-center text-muted">
                        <i class="bi bi-broadcast me-1 text-success"></i> Live Updates (10s)
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- 0. EXTENSION: Smooth Marker Movement (SlideTo) ---
    L.Marker.include({
        slideTo: function (latlng, duration) {
            this._slideToUntil = performance.now() + duration;
            this._slideToDuration = duration;
            this._slideToStartLatLng = this.getLatLng();
            this._slideToTargetLatLng = latlng;

            if (!this._slideFrameId) {
                this._slideFrameId = requestAnimationFrame(this._slideTo.bind(this));
            }
            return this;
        },
        _slideTo: function (timestamp) {
            if (timestamp < this._slideToUntil) {
                var progress = 1 - (this._slideToUntil - timestamp) / this._slideToDuration;
                var currentLat = this._slideToStartLatLng.lat + (this._slideToTargetLatLng.lat - this._slideToStartLatLng.lat) * progress;
                var currentLng = this._slideToStartLatLng.lng + (this._slideToTargetLatLng.lng - this._slideToStartLatLng.lng) * progress;
                this.setLatLng([currentLat, currentLng]);
                this._slideFrameId = requestAnimationFrame(this._slideTo.bind(this));
            } else {
                this.setLatLng(this._slideToTargetLatLng);
                this._slideFrameId = null;
            }
        }
    });

    var map = L.map('map').setView([2.9289, 101.6417], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var busMarkers = {}; 
    const UPDATE_INTERVAL = 10000; // 10 Seconds Refresh

    // Load Routes & Stops
    function loadStaticMapData() {
        fetch("{% url 'api_routes' %}")
            .then(res => res.json())
            .then(data => {
                data.routes.forEach(route => {
                    if (route.coords.length > 1) {
                        var waypoints = route.coords.map(c => `${c[1]},${c[0]}`).join(';');
                        var osrmUrl = `https://router.project-osrm.org/route/v1/driving/${waypoints}?overview=full&geometries=geojson`;

                        fetch(osrmUrl)
                            .then(r => r.json())
                            .then(osrmData => {
                                if (osrmData.routes && osrmData.routes.length > 0) {
                                    var roadCoords = osrmData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                                    L.polyline(roadCoords, {
                                        color: route.color, weight: 5, opacity: 0.8, lineJoin: 'round'
                                    }).addTo(map).bindPopup(`<b>Route:</b> ${route.name}`);
                                } else {
                                    L.polyline(route.coords, { color: route.color, weight: 4, opacity: 0.5, dashArray: '5,5' }).addTo(map);
                                }
                            })
                            .catch(e => {
                                L.polyline(route.coords, { color: route.color, weight: 4, opacity: 0.5, dashArray: '5,5' }).addTo(map);
                            });
                    }
                });
            });

        fetch("{% url 'api_stops' %}")
            .then(res => res.json())
            .then(data => {
                var stopIcon = L.divIcon({
                    className: 'custom-stop-icon',
                    html: '<div style="background:white; border:2px solid #333; width:12px; height:12px; border-radius:50%; box-shadow: 1px 1px 3px rgba(0,0,0,0.3);"></div>',
                    iconSize: [12, 12]
                });
                data.stops.forEach(stop => {
                    L.marker([stop.lat, stop.lng], {icon: stopIcon}).addTo(map)
                     .bindPopup(`<b>üöè Stop:</b> ${stop.name}`);
                });
            });
    }

    // Live Updates
    function updateBuses() {
        fetch("{% url 'api_shuttles' %}")
            .then(res => res.json())
            .then(data => {
                document.getElementById('shuttle-count').innerText = data.shuttles.length;
                
                var listHtml = '';
                var activeIds = [];

                if (data.shuttles.length === 0) {
                    listHtml = `
                        <li class="list-group-item text-center py-5 text-muted">
                            <i class="bi bi-bus-front fs-1 text-secondary opacity-50"></i>
                            <p class="mt-2 mb-0">No shuttles currently active.</p>
                        </li>`;
                }

                data.shuttles.forEach(bus => {
                    activeIds.push(bus.id);
                    
                    listHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold text-primary">${bus.plate}</h6>
                                <small class="text-muted">${bus.route}</small>
                            </div>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10">
                                Live
                            </span>
                        </li>`;

                    var popupContent = `
                        <div class="text-center p-1">
                            <b class="d-block text-primary mb-1">${bus.route}</b>
                            <span class="badge bg-dark">${bus.plate}</span>
                        </div>`;

                    if (busMarkers[bus.id]) {
                        // Smoothly slide to new location over 10 seconds
                        busMarkers[bus.id].slideTo([bus.lat, bus.lng], UPDATE_INTERVAL);
                        busMarkers[bus.id].setPopupContent(popupContent);
                    } else {
                        var busIcon = L.divIcon({
                            className: 'custom-bus-marker',
                            html: `
                                <div class="bus-marker-container">
                                    <div class="pulse-ring"></div>
                                    <img src="{% static 'img/bus_marker.png' %}" class="bus-icon-img" alt="Bus">
                                </div>
                            `,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                        var marker = L.marker([bus.lat, bus.lng], {icon: busIcon}).addTo(map).bindPopup(popupContent);
                        busMarkers[bus.id] = marker;
                    }
                });

                document.getElementById('shuttle-list').innerHTML = listHtml;

                // Remove stale markers
                for (var id in busMarkers) {
                    if (!activeIds.includes(parseInt(id))) {
                        map.removeLayer(busMarkers[id]);
                        delete busMarkers[id];
                    }
                }
            })
            .catch(err => console.error(err));
    }

    loadStaticMapData();
    updateBuses();
    setInterval(updateBuses, UPDATE_INTERVAL);
</script>
{% endblock %}