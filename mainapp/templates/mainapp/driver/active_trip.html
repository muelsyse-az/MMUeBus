{% extends 'mainapp/base.html' %}

{% block title %}Active Trip #{{ trip.trip_id }}{% endblock %}

{% block content %}
<style>
    /* Pulse Animation for GPS */
    .gps-pulse {
        width: 12px; height: 12px;
        background-color: #28a745;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 1.5s infinite;
        margin-right: 8px;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
</style>

<div class="app-content pt-3">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                
                <div class="text-center mb-3">
                    <span class="badge bg-white text-dark border shadow-sm py-2 px-3 rounded-pill">
                        <div id="gps-indicator" class="gps-pulse"></div> 
                        <span id="gps-text">GPS LIVE TRACKING</span>
                    </span>
                    <div id="status-msg" class="text-muted small mt-1" style="font-size: 0.75rem;">Initializing...</div>
                </div>

                <div class="card shadow-lg border-0">
                    <div class="card-header bg-success text-white text-center py-4">
                        <h6 class="text-uppercase opacity-75 mb-1">Current Route</h6>
                        <h2 class="fw-bold mb-0">{{ trip.schedule.route.name }}</h2>
                    </div>

                    <div class="card-body p-4">
                        
                        <div class="d-grid mb-4">
                            <a href="{% url 'notify_arrival' trip.trip_id %}" class="btn btn-warning btn-lg py-4 shadow-sm border border-warning-subtle">
                                <i class="bi bi-broadcast fs-1 d-block mb-2"></i>
                                <span class="fw-bold fs-4">ANNOUNCE ARRIVAL</span>
                                <div class="small fw-normal">Notify passengers at stop</div>
                            </a>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <div class="p-3 border rounded text-center bg-light h-100">
                                    <small class="text-muted text-uppercase fw-bold">Vehicle</small>
                                    <div class="fs-5 fw-bold text-dark">{{ trip.driverassignment_set.first.vehicle.plate_no }}</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'manage_trip_passengers' trip.trip_id %}" class="btn btn-outline-primary w-100 h-100 p-3 d-flex flex-column justify-content-center align-items-center">
                                    <i class="bi bi-people-fill fs-4 mb-1"></i>
                                    <span class="fw-bold">Passenger List</span>
                                </a>
                            </div>
                        </div>

                        <div class="d-grid">
                            <a href="{% url 'finish_trip' trip.trip_id %}" 
                               onclick="return confirm('Confirm END TRIP? This will close all bookings.');" 
                               class="btn btn-danger btn-lg py-3 fw-bold">
                                <i class="bi bi-stop-circle-fill me-2"></i> FINISH TRIP
                            </a>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    const tripId = "{{ trip.trip_id }}";
    const statusMsg = document.getElementById('status-msg');
    const gpsIndicator = document.getElementById('gps-indicator');
    const gpsText = document.getElementById('gps-text');

    const geoOptions = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };

    function sendLocation() {
        if (!navigator.geolocation) {
            gpsText.innerText = "GPS NOT SUPPORTED";
            gpsIndicator.style.backgroundColor = "red";
            gpsIndicator.style.animation = "none";
            return;
        }

        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = Math.round(position.coords.accuracy);
            
            statusMsg.innerText = `Signal Accuracy: ${accuracy}m â€¢ Last Update: ${new Date().toLocaleTimeString()}`;
            
            // Visual Feedback
            gpsIndicator.style.backgroundColor = "#28a745"; 
            gpsIndicator.style.animation = "pulse 1.5s infinite";

            fetch("{% url 'api_update_location' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": '{{ csrf_token }}' },
                body: JSON.stringify({ trip_id: tripId, lat: lat, lng: lng })
            }).catch(() => statusMsg.innerText = "Network Error - Retrying...");

        }, error => {
            gpsIndicator.style.backgroundColor = "#ffc107"; // Warning color
            gpsIndicator.style.animation = "none";
            gpsText.innerText = "GPS SIGNAL LOST";
        }, geoOptions);
    }
    
    sendLocation();
    setInterval(sendLocation, 10000);
</script>
{% endblock %}